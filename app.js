"use strict";(()=>{var A=1e3/20,E=class extends HTMLElement{intervalId=null;item;size=64;constructor(){super()}async connectedCallback(){let t=this.attachShadow({mode:"open"}),e=this.item;if(!e||!e.animation)throw new Error("animated item is required");let n=document.createElement("canvas"),o=e.image.width,r=e.animation;n.width=o,n.height=o,n.style.imageRendering="pixelated",n.style.width=`${this.size}px`,n.style.height=`${this.size}px`;let i=n.getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("No canvas context");i.imageSmoothingEnabled=!1;let s=0,c=0,m=C(e.image),u=o**2*4;this.intervalId=setInterval(()=>{c++>=r.frames[s].frameTime&&(c=0,s=(s+1)%r.frames.length);let d=o*r.frames[s].index;if(i.clearRect(0,0,o,o),i.drawImage(e.image,0,d,o,o,0,0,o,o),!r.interpolate)return;let l=c/r.frames[s].frameTime,M=(s+1)%r.frames.length,P=r.frames[M].index,O=u*P,w=i.getImageData(0,0,o,o);for(let h=0;h<w.data.length;h++)w.data[h]=k(l,w.data[h],m.data[O+h]);i.putImageData(w,0,0,0,0,o,o)},A),t.append(n)}disconnectedCallback(){this.intervalId!=null&&clearInterval(this.intervalId)}};function k(a,t,e){return a*(e-t)+t}function C(a){let t=document.createElement("canvas");t.width=a.width,t.height=a.height;let e=t.getContext("2d");if(!e)throw new Error("No canvas context");return e.imageSmoothingEnabled=!1,e.drawImage(a,0,0),e.getImageData(0,0,a.width,a.height)}var b=class extends HTMLElement{size=64;item;dataSource;constructor(){super()}async connectedCallback(){let t=this.attachShadow({mode:"open"}),e=document.createElement("div");if(e.style.minWidth=`${this.size}px`,e.style.minHeight=`${this.size}px`,t.append(e),!this.item||!this.dataSource)throw new Error("item and data source are required");let n=await this.dataSource.loadItem(this.item),o=this.getElementForItem(n);e.append(o)}getElementForItem(t){if(t.animation){let n=document.createElement("animated-texture");return n.item=t,n.size=this.size,n}let e=document.createElement("div");return e.style.backgroundImage=`url(${t.image.src})`,e.style.backgroundSize="contain",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.imageRendering="pixelated",e.style.width=`${this.size}px`,e.style.height=`${this.size}px`,e}};var y=class extends HTMLElement{teardown;text;constructor(){super()}connectedCallback(){let t=this.attachShadow({mode:"open"}),e=this.text??"",n=document.createElement("div");n.addEventListener("mouseenter",r=>{let i=document.createElement("div");i.classList.add("tooltip"),i.innerText=e,this.positionTooltip(i,r),document.body.append(i);let s=c=>{this.positionTooltip(i,c)};document.body.addEventListener("mousemove",s),this.teardown=()=>{document.body.removeEventListener("mousemove",s),i.remove()}}),n.addEventListener("mouseleave",()=>{this.teardown?.()});let o=document.createElement("slot");n.append(o),t.append(n)}positionTooltip(t,e){let{width:n,height:o}=t.getBoundingClientRect(),r=I(window.innerWidth,n,e.clientX),i=I(window.innerHeight,o,e.clientY),s=[!r&&`left: ${e.clientX+10}px;`,r&&`right: ${window.innerWidth-e.clientX+10}px;`,!i&&`top: ${e.clientY+10}px;`,i&&`bottom: ${window.innerHeight-e.clientY+10}px;`].filter(c=>c).join("");t.setAttribute("style",s)}disconnectedCallback(){this.teardown?.()}};function I(a,t,e){return e>=a-t-10-10}function f(){return{subfolders:new Map,items:new Map}}function v(a,t){let e=t.width,n=t.height/e,o=a.animation.frametime??1,r=a.animation.interpolate??!1,i=a.animation.frames;return{interpolate:r,frames:i?R(i,o):N(n,o)}}function N(a,t){return[...new Array(a)].map((e,n)=>({frameTime:t,index:n}))}function R(a,t){return a.map(e=>typeof e=="number"?{index:e,frameTime:t}:{index:e.index,frameTime:e.time})}var p=class{constructor(t,e,n,o){this.username=t;this.repo=e;this.branch=n;this.root=o}getNavBarClass(){return"github"}addDescriptionToNav(t){let e=document.createElement("div");e.innerText=`${this.username}/${this.repo}`;let n=document.createElement("div");n.innerText="GitHub",t.append(e),t.append(n)}addItemsToMenu(t){let e=document.createElement("div");e.innerText="View on GitHub",e.addEventListener("click",()=>{window.open(`https://github.com/${this.username}/${this.repo}`)}),t.append(e)}async getRootFolder(){let t=`https://api.github.com/repos/${this.username}/${this.repo}/git/trees/${this.branch}?recursive=1`,e=await fetch(t),{tree:n}=await e.json(),o=f(),r=/^(.*)\/(.*)\.png(\.mcmeta)?$/;for(let i of n){let s=i.path.match(r);if(!s)continue;let[,c,m,u]=s;if(!c.startsWith(this.root))continue;let d=this.findOrCreateSubfolder(o,c),l=u!=null;(!d.items.has(m)||l)&&d.items.set(m,{imagePath:`${c}/${m}.png`,mcMetaPath:l?`${c}/${m}.png.mcmeta`:void 0})}return o}async loadItem(t){let e=await this.loadImage(t.imagePath),n=await this.loadMcMeta(t.mcMetaPath,e);return{image:e,animation:n}}findOrCreateSubfolder(t,e){let n=e.split("/"),o=t;for(let r of n)o.subfolders.has(r)||o.subfolders.set(r,f()),o=o.subfolders.get(r);return o}getGithubUserContentPath(t){return`https://raw.githubusercontent.com/${this.username}/${this.repo}/${this.branch}/${t}`}loadImage(t){return new Promise(e=>{let n=new Image;n.src=this.getGithubUserContentPath(t),n.crossOrigin="anonymous",n.addEventListener("load",()=>{e(n)})})}async loadMcMeta(t,e){if(t)try{let o=await(await fetch(this.getGithubUserContentPath(t))).json();return v(o,e)}catch(n){console.error(`Couldn't load ${t}:`,n)}}};function F(a,t){let e=document.createElement("div");e.classList.add("overlay");let n=document.createElement("div");n.classList.add("modal");let o=document.createElement("texture-loader");o.size=Math.min(window.innerHeight,window.innerWidth)-40,o.dataSource=a,o.item=t,n.append(o),e.addEventListener("click",T),n.addEventListener("click",T),document.body.append(e),document.body.append(n)}function L(){document.body.addEventListener("keydown",a=>{a.key==="Escape"&&(a.preventDefault(),T())})}function T(){document.querySelector(".overlay")?.remove(),document.querySelector(".modal")?.remove()}async function g(a){_(a),z(a),B(a),q(),await G(a)}function _(a){document.querySelector("nav").setAttribute("class",a.getNavBarClass())}function z(a){let t=document.querySelector(".dataSource");t.innerHTML="",a.addDescriptionToNav(t)}function B(a){let t=document.querySelector("#dataSourceMenuExtraItems");if(t.innerHTML="",a.addItemsToMenu?.(t),t.childNodes.length>0){let e=document.createElement("div");e.classList.add("divider"),t.append(e)}}function q(){let a=document.querySelector("#search");a.value=""}async function G(a){let t=await a.getRootFolder(),e=S(t),n=document.createDocumentFragment();for(let r of e){let i=r.name.toString().trim(),s=[...r.items.entries()].sort((c,m)=>c[0].localeCompare(m[0]));for(let[c,m]of s){let u=c.toLowerCase().trim(),d=document.createElement("tool-tip");d.text=`${r.name}/${c}`,d.setAttribute("data-searchable-name",`${i}/${u}`);let l=document.createElement("texture-loader");l.dataSource=a,l.item=m,d.addEventListener("click",()=>{F(a,m)}),d.append(l),n.append(d)}}let o=document.querySelector("#textures");o.innerHTML="",o.append(n)}function S(a){let t=[];for(let[e,n]of a.subfolders){let o=S(n);t.push(...o),t.push({name:e,items:n.items})}return t}async function D(){let a=window.location.hash.split("/");a[0]==="#github"&&a[1]&&a[2]&&a[3]&&await g(new p(a[1],a[2],a[3],""))}function $(){let a=document.querySelector("#search");a.addEventListener("input",()=>{document.querySelectorAll("[data-searchable-name]").forEach(e=>{if(!(e instanceof HTMLElement))return;let o=e.getAttribute("data-searchable-name")?.includes(a.value);e.style.display=o?"block":"none"})}),document.addEventListener("keydown",t=>{(t.key==="/"||(t.metaKey||t.ctrlKey)&&t.key==="f")&&(t.preventDefault(),a.focus())})}var x=class{constructor(t){this.directory=t}getNavBarClass(){return"local"}addDescriptionToNav(t){let e=document.createElement("div");e.innerText=this.directory.name;let n=document.createElement("div");n.innerText="Local",t.append(e),t.append(n)}async getRootFolder(){return this.loadFoldersRecursively(this.directory,"")}async loadItem(t){let{imageHandle:e,mcMetaHandle:n}=await this.findImageAndMcMeta(t),o=await this.loadImage(e),r=await this.loadMcMeta(n,t.mcMetaPath,o);return{image:o,animation:r}}async loadFoldersRecursively(t,e){let n=f(),o=/(.*)\.png(\.mcmeta)?/;for await(let[r,i]of t.entries()){if(i.kind==="directory"){let l=await this.loadFoldersRecursively(i,`${e}/${r}`);n.subfolders.set(r,l);continue}let s=r.match(o);if(!s)continue;let[,c,m]=s,u=m!=null;(!n.items.has(r)||u)&&n.items.set(c,{imagePath:`${e}/${c}.png`,mcMetaPath:u?`${e}/${c}.png.mcmeta`:void 0})}return n}async findImageAndMcMeta(t){let e=t.imagePath.slice(1).split("/"),n=this.directory;for(let s of e.slice(0,-1))n=await n.getDirectoryHandle(s);let o=e.at(-1);if(!o)throw new Error("Couldn't find item");let r=await n.getFileHandle(o),i;return t.mcMetaPath&&(i=await n.getFileHandle(`${o}.mcmeta`)),{imageHandle:r,mcMetaHandle:i}}async loadImage(t){return new Promise(async e=>{let n=await t.getFile(),o=new FileReader;o.addEventListener("load",()=>{let r=new Image;r.src=o.result,e(r)}),o.readAsDataURL(n)})}async loadMcMeta(t,e,n){if(!t)return;let o;try{o=await(await t.getFile()).text();let i=JSON.parse(o);return v(i,n)}catch(r){console.error(`Couldn't load ${e}:`,r,o)}}};function H(){let a=document.querySelector("#dataSourceMenuOpenItems"),t=document.createElement("div");t.addEventListener("click",X),t.innerText="Open from GitHub";let e=document.createElement("div");e.addEventListener("click",U),e.innerText="Open from your computer",a.append(t),a.append(e)}async function X(){let a=prompt("Enter the URL to a GitHub repo, and we'll find the textures in it:");if(!a)return;let t=a.match(/^(https?:\/\/)?github\.com\/([^\/]+)\/([^\/]+)/);if(!t)return;let[,,e,n]=t,o=`https://api.github.com/repos/${e}/${n}`,r=await fetch(o),{default_branch:i}=await r.json();window.location.hash=`github/${e}/${n}/${i}`,g(new p(e,n,i,""))}async function U(){if(!window.showDirectoryPicker){alert("Your browser does not support selecting directories. Try Chrome.");return}let a=await window.showDirectoryPicker();window.location.hash="",g(new x(a))}window.addEventListener("load",async()=>{H(),$(),L(),await D()});window.customElements.define("animated-texture",E);window.customElements.define("texture-loader",b);window.customElements.define("tool-tip",y);})();
